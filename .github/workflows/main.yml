name: Mastodon zu Gotify

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  check-feed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v4
      
      - name: RSS-Feed prüfen und zu Gotify senden
        env:
          GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
        run: |
          python3 << 'EOF'
          import urllib.request
          import xml.etree.ElementTree as ET
          import json
          import os
          import html
          import re
          
          RSS_URL = "https://mastodon.de/@adhs_mzg.rss"
          GOTIFY_TOKEN = os.environ['GOTIFY_TOKEN']
          STATE_FILE = "last_post.txt"
          
          print("=== Abrufen des RSS-Feeds ===")
          
          # RSS-Feed abrufen
          with urllib.request.urlopen(RSS_URL) as response:
              tree = ET.parse(response)
          
          # Neuesten Beitrag finden
          item = tree.find('.//item')
          if item is None:
              print("Keine Items im Feed gefunden!")
              exit(0)
          
          latest_link = item.find('link').text
          
          # Title oder Description nutzen
          title_elem = item.find('title')
          desc_elem = item.find('description')
          
          if title_elem is not None and title_elem.text:
              latest_title = title_elem.text
          elif desc_elem is not None and desc_elem.text:
              latest_title = desc_elem.text
          else:
              latest_title = "Neuer Beitrag"
          
          # HTML-Tags entfernen und HTML-Entities dekodieren
          latest_title = re.sub('<[^<]+?>', '', latest_title)
          latest_title = html.unescape(latest_title)
          latest_title = latest_title.strip()[:500]  # Auf 500 Zeichen kürzen
          
          print(f"Neuester Link: {latest_link}")
          print(f"Neuester Titel: {latest_title}")
          
          # Letzten gespeicherten Beitrag laden
          try:
              with open(STATE_FILE, 'r') as f:
                  last_link = f.read().strip()
              print(f"Letzter gespeicherter Link: {last_link}")
          except FileNotFoundError:
              last_link = ""
              print("Keine last_post.txt gefunden - erster Lauf")
          
          # Vergleichen und senden
          if latest_link != last_link and latest_link:
              print("=== NEUER BEITRAG ERKANNT! ===")
              print("Sende zu Gotify...")
              
              # Gotify-Request vorbereiten
              url = f"https://push.adminforge.de/message?token={GOTIFY_TOKEN}"
              
              data = {
                  'title': 'Neuer Mastodon-Beitrag',
                  'message': latest_title,
                  'priority': 5,
                  'extras': {
                      'client::notification': {
                          'click': {
                              'url': latest_link
                          }
                      }
                  }
              }
              
              # Als multipart/form-data senden
              boundary = '----WebKitFormBoundary' + '1234567890'
              body = []
              
              for key, value in [('title', data['title']), ('message', data['message']), ('priority', str(data['priority']))]:
                  body.append(f'--{boundary}'.encode())
                  body.ap
