name: Mastodon zu Gotify

on:
  schedule:
    - cron: '*/15 * * * *'  # Alle 15 Minuten
  workflow_dispatch:  # Erlaubt manuelles Auslösen

jobs:
  check-feed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v4
      
      - name: RSS-Feed prüfen und zu Gotify senden
        env:
          GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
        run: |
          # Mastodon RSS-Feed URL
          RSS_URL="https://mastodon.de/@adhs_mzg.rss"
          
          # Neuesten Beitrag abrufen
          LATEST_LINK=$(curl -s "$RSS_URL" | xmllint --xpath "//item[1]/link/text()" - 2>/dev/null)
          LATEST_TITLE=$(curl -s "$RSS_URL" | xmllint --xpath "//item[1]/title/text()" - 2>/dev/null | sed 's/<[^>]*>//g')
          
          # Letzten gespeicherten Beitrag laden
          if [ -f last_post.txt ]; then
            LAST_LINK=$(cat last_post.txt)
          else
            LAST_LINK=""
          fi
          
          # Wenn neuer Beitrag, zu Gotify senden
          if [ "$LATEST_LINK" != "$LAST_LINK" ] && [ -n "$LATEST_LINK" ]; then
            echo "Neuer Beitrag gefunden: $LATEST_TITLE"
            
            curl "https://push.adminforge.de/message?token=$GOTIFY_TOKEN" \
              -F "title=ADHS-MZG Selbsthilfe" \
              -F "message=$LATEST_TITLE" \
              -F "priority=5" \
              -F "extras={\"client::notification\":{\"click\":{\"url\":\"$LATEST_LINK\"}}}"
            
            # Aktuellen Beitrag speichern
            echo "$LATEST_LINK" > last_post.txt
          else
            echo "Kein neuer Beitrag gefunden."
          fi
      
      - name: Status speichern
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_post.txt || true
          git diff --quiet && git diff --staged --quiet || git commit -m "Update last post"
          git push || true
