name: Mastodon zu Gotify

on:
  schedule:
    - cron: '*/15 * * * *'  # Alle 15 Minuten
  workflow_dispatch:  # Erlaubt manuelles Auslösen

jobs:
  check-feed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v4

      - name: xmllint installieren
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils
      
          - name: RSS-Feed prüfen und zu Gotify senden
            env:
              GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
            run: |
              RSS_URL="https://mastodon.de/@adhs_mzg.rss"
              
              echo "=== Abrufen des RSS-Feeds ==="
              LATEST_LINK=$(curl -s "$RSS_URL" | xmllint --xpath "//item[1]/link/text()" - 2>/dev/null)
              
              # Versuche zuerst title, dann description
              LATEST_TITLE=$(curl -s "$RSS_URL" | xmllint --xpath "//item[1]/title/text()" - 2>/dev/null)
              if [ -z "$LATEST_TITLE" ]; then
                LATEST_TITLE=$(curl -s "$RSS_URL" | xmllint --xpath "//item[1]/description/text()" - 2>/dev/null | sed 's/<[^>]*>//g')
              fi
              
              # Titel kürzen falls zu lang
              LATEST_TITLE=$(echo "$LATEST_TITLE" | head -c 1000)
              
              echo "Neuester Link: $LATEST_LINK"
              echo "Neuester Titel: $LATEST_TITLE"
              
              if [ -f last_post.txt ]; then
                LAST_LINK=$(cat last_post.txt)
                echo "Letzter gespeicherter Link: $LAST_LINK"
              else
                LAST_LINK=""
                echo "Keine last_post.txt gefunden"
              fi
              
              if [ "$LATEST_LINK" != "$LAST_LINK" ] && [ -n "$LATEST_LINK" ]; then
                echo "=== NEUER BEITRAG ERKANNT! ==="
                
                # Fallback falls Titel immer noch leer
                if [ -z "$LATEST_TITLE" ]; then
                  LATEST_TITLE="Neuer Beitrag (kein Titel verfügbar)"
                fi
                
                echo "Sende zu Gotify..."
                curl "https://push.adminforge.de/message?token=$GOTIFY_TOKEN" \
                  -F "title=ADHS-MZG Selbsthilfe" \
                  -F "message=$LATEST_TITLE" \
                  -F "priority=5" \
                  -F "extras={\"client::notification\":{\"click\":{\"url\":\"$LATEST_LINK\"}}}"
                
                echo "$LATEST_LINK" > last_post.txt
                echo "✓ Gespeichert!"
              else
                echo "=== Kein neuer Beitrag ==="
              fi

      
      - name: Status speichern
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_post.txt || true
          git diff --quiet && git diff --staged --quiet || git commit -m "Update last post"
          git push || true
