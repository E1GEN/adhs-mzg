name: Mastodon zu Gotify

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  check-feed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v4
      
      - name: RSS-Feed prüfen und zu Gotify senden
        env:
          GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
        run: |
          python3 << 'EOF'
          import urllib.request
          import urllib.error
          import xml.etree.ElementTree as ET
          import json
          import os
          import html
          import re
          import sys
          
          RSS_URL = "https://mastodon.de/@adhs_mzg.rss"
          GOTIFY_URL = "https://push.adminforge.de/message"
          GOTIFY_TOKEN = os.environ['GOTIFY_TOKEN']
          STATE_FILE = "last_post.txt"
          
          try:
              print("=== Abrufen des RSS-Feeds ===")
              print(f"RSS URL: {RSS_URL}")
              
              # RSS-Feed abrufen
              req = urllib.request.Request(RSS_URL, headers={'User-Agent': 'Mozilla/5.0'})
              with urllib.request.urlopen(req, timeout=10) as response:
                  tree = ET.parse(response)
              
              print("✓ RSS-Feed erfolgreich abgerufen")
              
              # Neuesten Beitrag finden
              item = tree.find('.//item')
              if item is None:
                  print("⚠ Keine Items im Feed gefunden - beende ohne Fehler")
                  sys.exit(0)
              
              # Link extrahieren
              link_elem = item.find('link')
              if link_elem is None or not link_elem.text:
                  print("✗ Kein Link im Item gefunden!")
                  sys.exit(1)
              latest_link = link_elem.text.strip()
              
              # Title oder Description nutzen
              latest_title = None
              title_elem = item.find('title')
              desc_elem = item.find('description')
              
              if title_elem is not None and title_elem.text:
                  latest_title = title_elem.text
              elif desc_elem is not None and desc_elem.text:
                  latest_title = desc_elem.text
              
              if not latest_title:
                  latest_title = "Neuer Beitrag"
              
              # HTML-Tags entfernen und HTML-Entities dekodieren
              latest_title = re.sub('<[^<]+?>', '', latest_title)
              latest_title = html.unescape(latest_title)
              latest_title = latest_title.strip()[:500]
              
              print(f"Neuester Link: {latest_link}")
              print(f"Neuester Titel: {latest_title[:100]}...")
              
              # Letzten gespeicherten Beitrag laden
              try:
                  with open(STATE_FILE, 'r') as f:
                      last_link = f.read().strip()
                  print(f"Letzter gespeicherter Link: {last_link}")
              except FileNotFoundError:
                  last_link = ""
                  print("Keine last_post.txt gefunden - erster Lauf")
              
              # Vergleichen und senden
              if latest_link == last_link:
                  print("=== Kein neuer Beitrag ===")
                  sys.exit(0)
              
              if not latest_link:
                  print("✗ Latest Link ist leer!")
                  sys.exit(1)
              
              print("=== NEUER BEITRAG ERKANNT! ===")
              print("Sende zu Gotify...")
              
              # Gotify-Request als JSON
              data = json.dumps({
                  'title': 'ADHS-MZG Selbsthilfe',
                  'message': latest_title,
                  'priority': 5,
                  'extras': {
                      'client::notification': {
                          'click': {
                              'url': latest_link
                          }
                      }
                  }
              }).encode('utf-8')
              
              req = urllib.request.Request(
                  f"{GOTIFY_URL}?token={GOTIFY_TOKEN}",
                  data=data,
                  headers={'Content-Type': 'application/json'}
              )
              
              with urllib.request.urlopen(req, timeout=10) as response:
                  resp_data = response.read().decode('utf-8')
                  print(f"✓ Gotify Response Code: {response.status}")
                  print(f"Response: {resp_data}")
              
              # Speichern
              with open(STATE_FILE, 'w') as f:
                  f.write(latest_link)
              print("✓ Erfolgreich gespeichert!")
              
          except urllib.error.HTTPError as e:
              print(f"✗ HTTP-Fehler: {e.code} - {e.reason}")
              print(f"URL: {e.url}")
              sys.exit(1)
          except urllib.error.URLError as e:
              print(f"✗ URL-Fehler: {e.reason}")
              sys.exit(1)
          except ET.ParseError as e:
              print(f"✗ XML-Parsing-Fehler: {e}")
              sys.exit(1)
          except Exception as e:
              print(f"✗ Unerwarteter Fehler: {type(e).__name__}: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          EOF
      
      - name: Status speichern
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_post.txt || true
          git diff --quiet && git diff --staged --quiet || git commit -m "Update last post"
          git push || true
