name: Mastodon zu Gotify

on:
  schedule:
    - cron: '*/15 * * * *'  # Alle 15 Minuten
  workflow_dispatch:  # Erlaubt manuelles Auslösen

jobs:
  check-feed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v4

      - name: xmllint installieren
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils
      
          - name: RSS-Feed prüfen und zu Gotify senden
            env:
              GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
            run: |
              RSS_URL="https://deine-instanz/@deinusername.rss"
              
              # Python statt xmllint verwenden
              LATEST=$(python3 -c "
          import urllib.request
          import xml.etree.ElementTree as ET
          with urllib.request.urlopen('$RSS_URL') as response:
              tree = ET.parse(response)
              item = tree.find('.//item')
              print(item.find('link').text + '|' + item.find('title').text)
          ")
    
              LATEST_LINK=$(echo "$LATEST" | cut -d'|' -f1)
              LATEST_TITLE=$(echo "$LATEST" | cut -d'|' -f2 | sed 's/<[^>]*>//g')
          
          # Letzten gespeicherten Beitrag laden
          if [ -f last_post.txt ]; then
            LAST_LINK=$(cat last_post.txt)
          else
            LAST_LINK=""
          fi
          
          # Wenn neuer Beitrag, zu Gotify senden
          if [ "$LATEST_LINK" != "$LAST_LINK" ] && [ -n "$LATEST_LINK" ]; then
            echo "Neuer Beitrag gefunden: $LATEST_TITLE"
            
            curl "https://push.adminforge.de/message?token=$GOTIFY_TOKEN" \
              -F "title=ADHS-MZG Selbsthilfe" \
              -F "message=$LATEST_TITLE" \
              -F "priority=5" \
              -F "extras={\"client::notification\":{\"click\":{\"url\":\"$LATEST_LINK\"}}}"
            
            # Aktuellen Beitrag speichern
            echo "$LATEST_LINK" > last_post.txt
          else
            echo "Kein neuer Beitrag gefunden."
          fi
      
      - name: Status speichern
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_post.txt || true
          git diff --quiet && git diff --staged --quiet || git commit -m "Update last post"
          git push || true
