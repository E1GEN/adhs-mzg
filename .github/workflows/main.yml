name: Mastodon zu Gotify

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  check-feed:
    runs-on: ubuntu-latest
    
    steps:
      - name: Repository auschecken
        uses: actions/checkout@v4
      
      - name: RSS-Feed prüfen und zu Gotify senden
        env:
          GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
        run: |
          python3 << 'EOF'
          import urllib.request
          import urllib.error
          import xml.etree.ElementTree as ET
          import json
          import os
          import html
          import re
          import sys
          
          RSS_URL = "https://mastodon.de/@adhs_mzg.rss"
          GOTIFY_URL = "https://push.adminforge.de/message"
          GOTIFY_TOKEN = os.environ['GOTIFY_TOKEN']
          STATE_FILE = "last_post.txt"
          
          try:
              print("=== Abrufen des RSS-Feeds ===")
              
              # RSS-Feed abrufen
              req = urllib.request.Request(RSS_URL, headers={'User-Agent': 'Mozilla/5.0'})
              with urllib.request.urlopen(req, timeout=10) as response:
                  tree = ET.parse(response)
              
              print("✓ RSS-Feed erfolgreich abgerufen")
              
              # Neuesten Beitrag finden
              item = tree.find('.//item')
              if item is None:
                  print("⚠ Keine Items im Feed gefunden")
                  sys.exit(0)
              
              # Link extrahieren (zuerst link, dann guid als Fallback)
              latest_link = None
              link_elem = item.find('link')
              if link_elem is not None and link_elem.text:
                  latest_link = link_elem.text.strip()
              else:
                  guid_elem = item.find('guid')
                  if guid_elem is not None and guid_elem.text:
                      latest_link = guid_elem.text.strip()
              
              if not latest_link:
                  print("✗ Kein Link gefunden!")
                  sys.exit(1)
              
              # Title oder Description
              latest_title = None
              title_elem = item.find('title')
              desc_elem = item.find('description')
              
              if title_elem is not None and title_elem.text:
                  latest_title = title_elem.text
              elif desc_elem is not None and desc_elem.text:
                  latest_title = desc_elem.text
              else:
                  latest_title = "Neuer Beitrag"
              
              # HTML bereinigen
              latest_title = re.sub('<[^<]+?>', '', latest_title)
              latest_title = html.unescape(latest_title)
              latest_title = latest_title.strip()[:500]
              
              print(f"Link: {latest_link}")
              print(f"Titel: {latest_title[:100]}...")
              
              # Letzten Beitrag laden
              try:
                  with open(STATE_FILE, 'r') as f:
                      last_link = f.read().strip()
                  print(f"Letzter Link: {last_link}")
              except FileNotFoundError:
                  last_link = ""
                  print("Erster Lauf")
              
              # Vergleichen
              if latest_link == last_link:
                  print("=== Kein neuer Beitrag ===")
                  sys.exit(0)
              
              print("=== NEUER BEITRAG! ===")
              print("Sende zu Gotify...")
              
              # Gotify mit Form-Data (extras als JSON-String im Form-Field)
              import urllib.parse
              
              extras_json = json.dumps({
                  'client::notification': {
                      'click': {
                          'url': latest_link
                      }
                  }
              })
              
              data = urllib.parse.urlencode({
                  'title': 'ADHS-MZG Selbsthilfe',
                  'message': latest_title,
                  'priority': '5',
                  'extras': extras_json
              }).encode('utf-8')
              
              req = urllib.request.Request(
                  f"{GOTIFY_URL}?token={GOTIFY_TOKEN}",
                  data=data,
                  headers={'Content-Type': 'application/x-www-form-urlencoded'}
              )
              
              with urllib.request.urlopen(req, timeout=10) as response:
                  print(f"✓ Gotify Response: {response.status}")
              
              # Speichern
              with open(STATE_FILE, 'w') as f:
                  f.write(latest_link)
              print("✓ Gespeichert!")
              
          except Exception as e:
              print(f"✗ Fehler: {type(e).__name__}: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          EOF
      
      - name: Status speichern
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_post.txt || true
          git diff --quiet && git diff --staged --quiet || git commit -m "Update last post"
          git push || true
